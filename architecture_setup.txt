Hetzner Server
- created SSH keys on my local machine
- when making the Hetzner Server, I passed the public key to Hetzner

Logging into server:
   -  ssh root@91.107.196.130
   -  ssh aleksa@91.107.196.130


Adding a new user
   - in the server: adduser aleksa
   - password: 
   - give it sudo rights: usermod -aG sudo aleksa
   - from a local machine, open new terminal, copy the ssh keys : ssh-copy-id aleksa@91.107.196.130
   - login with the new user: ssh aleksa@91.107.196.130
   - I should disable root SSH login in the : sudo nano /etc/ssh/sshd_config - but I didn't do that

Buy a Domain
   - go to the registrar e.g. Namecheap and buy a domain name
   - in the Advanced DNS point the domain name to the Server IP address 91.107.196.130

Install Nginx on the Server
   - sudo apt install nginx
   - create Nginx config file: sudo nano /etc/nginx/sites-available/maleckicoa
   - in the config file, configure Nginx to proxy the app: listen on port 80, Python on port 8000, Next.js on port 3000
   - enable the site: sudo ln -s /etc/nginx/sites-available/maleckicoa /etc/nginx/sites-enabled/
   - reload Nginx: sudo systemctl reload nginx
   - recap: to start Nginx: sudo systemctl start nginx
   - recap: to stop Nginx: sudo systemctl stop nginx (Nginx is a Deamon, closing the terminal will not kill  it)

Enable HTTPS for NGINX server (Add HTTPS encryption, i.e. get a free SSL certificate) for your domain maleckicoa.com: 
   - sudo apt install certbot python3-certbot-nginx
   - sudo certbot --nginx -d maleckicoa.com -d www.maleckicoa.com


Setup Code Repo
   - cd into where the code will be copied: cd/var/www
   - change permission : sudo chown -R aleksa:aleksa /var/www/maleckicoa.com
   - generate an SSH key for Github conection: ssh-keygen -t ed25519 -C "maleckicoa"
   - not sure what it does: eval "$(ssh-agent -s)"
   - not sure what it does: ssh-add ~/.ssh/id_ed25519
   - generate SSH key: cat ~/.ssh/id_ed25519.pub
   - copy the output and save it as New SSH Key in Github (Key name:hetzner-server)
   - test connection: ssh -T git@github.com
   - clone the repo: git clone git@github.com:maleckicoa/naro_index_advisor.git maleckicoa.com


Setup poetry
   - cd into home/aleksa and run:
      curl -sSL https://install.python-poetry.org | python3 -
      export PATH="$HOME/.local/bin:$PATH"  # add to ~/.bashrc or ~/.zshrc if needed

   - cd into repo again: cd /var/www/maleckicoa.com/etl-service
   - poetry config virtualenvs.in-project true
   - poetry install

Docker
   - Updates your package list: sudo apt update
   - Installs Docker Engine and docker-compose: sudo apt install -y docker.io docker-compose
   - Ensures Docker starts automatically on boot: sudo systemctl enable docker
   - Allows your user (e.g. aleksa) to run Docker commands without sudo: sudo usermod -aG docker $USER
   - log out from terminal (exit) and log in again(ssh aleksa@91.107.196.130)
   - cd into /var/www/maleckicoa.com/etl-service and run: cat docker-compose.yml
   - run: docker-compose up -d



Connnect Dbaver to postgres
   - open container: docker exec -it naro-index-advisor-postgres bash
   - install vim in the container: apt update && apt install -y vim
   - open the file: vi /var/lib/postgresql/data/postgresql.conf
   - add into the file: listen_addresses = '*'
   - then open another file: vi /var/lib/postgresql/data/pg_hba.conf
   - add into the file: host    all             all             0.0.0.0/0               md5
   - restart container: naro-index-advisor-postgres
   - check firewall on hetzner server: sudo ufw allow 5432/tcp
   - Open Dbeaver and make connection: host:91.107.196.130, user:$POSTGRES_USER, password: $POSTGRES_PASSWORD


Run code on Hetzner
   - cd into the project and fetch the latest code changes from remote: git pull
   - cd into where the python environment is and run: poetry run python script_name.py

Setup Webhook
   - Go to your remote repo on Github -> Settings -> Webhooks
   - Define payload: http://91.107.196.130:5000/github-webhook
   - Content type: application/json
   - Secret: Armadacompaso/7

   - Log into remote server: ssh aleksa@91.107.196.130
   - install Flask, in the etl-service run Poetry add flask
   - make a webhook_listener script in the home/user/webhook_listener/webhook_listener.py
   - activate the webhook process: nohup poetry run python /home/aleksa/webhook_listener/webhook_listener.py > /home/aleksa/webhook_listener/webhook.log 2>&1 &
   - this will output the PID of the process, to find and see the process later run: ps aux | grep webhook_listener.py
   - list all background processes: jobs -l
   - to kill the process run: pkill -f webhook_listener.py

Run Data ETL
- Set up the process: nohup poetry run python /var/www/maleckicoa.com/etl-service/daily_main.py > /var/www/maleckicoa.com/etl-service/daily_main.log 2>&1 &
- make sure that terminal is not connected to process:   disown 141486       (put here the process number you got from the previous command)
- See if the process is running: ps aux | grep daily_main.py
- See logs: tail -f /var/www/maleckicoa.com/etl-service/daily_main.log
- SEE LOGS: cat /var/www/maleckicoa.com/etl-service/daily_main.log
-------------------------------------------------------
- cd /var/www/maleckicoa.com 
- nohup make historical > etl_service.log 2>&1 &
- nohup make daily-schedule > etl_service.log 2>&1 &
- watch the log:                                         tail -f etl_service.log
- close the log:                                         Ctrl + C
- see if the make pricess is running :                   ps aux | grep '[m]ake historical'
- see if the make pricess is running :                   ps aux | grep '[m]ake daily'
- see the log file:                                      cat etl_service.log





Install Node on remote Server:
- curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
- sudo apt install -y nodejs build-essential
- sudo npm i -g pm2

Set up the .env file
cd into project:                                  cd /var/www/maleckicoa.com/frontend
copy local to production  env file:       cp .env.local .env.production 2>/dev/null || true
edit env file it if needed:               nano .env.production

Install exactly the dependencies this project needs, from scratch, and then compile it into a production build
- npm ci
- npm run build

Start the app on port 3000 with PM2
(PM2 is a process manager for Node.js applications â€” basically a tool that keeps your app running in the background)

- pm2 start "npm run start -- -p 3000" --name next-frontend --cwd /var/www/maleckicoa.com/frontend
- pm2 startup systemd
- pm2 save
- pm2 logs next-frontend



Make changes to the nginx file: sudo nano /etc/nginx/sites-available/maleckicoa

Enable + Reload?
sudo ln -sf /etc/nginx/sites-available/maleckicoa /etc/nginx/sites-enabled/maleckicoa
sudo nginx -t && sudo systemctl reload nginx
